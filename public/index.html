<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YellowPages Mobile Scraper</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="icon" href="assets/yellow_book.png" />
    <style>
      :root {
        --primary-color: #ffc107;
        --secondary-color: #343a40;
        --accent-color: #2fcef0;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --light-color: #f8f9fa;
        --dark-color: #1a1a1a;
        --border-color: #dee2e6;
        --border-radius: 8px;
        --shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        --transition: all 0.3s ease;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--dark-color);
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
      }

      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
      }

      header {
        background-color: var(--primary-color);
        text-align: center;
        padding: 1rem 0;
        box-shadow: var(--shadow);
      }

      header h1 {
        margin: 0;
        font-size: 1.8rem;
      }

      header p {
        margin-top: 0.5rem;
        font-size: 1rem;
        opacity: 0.8;
      }

      #logoutBtn,
      #searchBtn,
      header,
      .card-header,
      .range-value,
      .modal-close,
      .file-actions button,
      .modal-footer button {
        color: #1a1a1a !important;
      }

      nav {
        background-color: var(--secondary-color);
        color: var(--light-color);
        display: flex;
        justify-content: center;
        padding: 0.5rem 0;
      }

      nav button {
        background: none;
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        border-radius: var(--border-radius);
        transition: var(--transition);
        margin: 0 0.25rem;
        background-color: rgba(255, 255, 255, 0.1);
      }

      nav button:hover {
        background-color: rgba(255, 255, 255, 0.25);
      }

      nav button.active {
        background-color: var(--primary-color);
        color: black;
        font-weight: bold;
      }

      nav button i {
        margin-right: 5px;
      }

      main {
        padding: 1rem 0;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .card {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 1rem;
        overflow: hidden;
      }

      .card-header {
        background-color: var(--primary-color);
        color: var(--dark-color);
        padding: 0.75rem;
        font-weight: bold;
      }

      .card-body {
        padding: 1rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      input,
      select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.25);
      }

      .range-container {
        display: flex;
        align-items: center;
      }

      .range-container input[type="range"] {
        flex: 1;
      }

      .range-value {
        min-width: 48px;
        text-align: center;
        margin-left: 10px;
        padding: 0.25rem 0.5rem;
        background: var(--primary-color);
        border-radius: var(--border-radius);
        font-weight: bold;
      }

      button {
        background-color: var(--primary-color);
        color: var(--dark-color);
        border: none;
        padding: 0.75rem 1rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      button i {
        margin-inline: 5px;
      }

      button:hover {
        background-color: #e0a800;
      }

      button:disabled {
        background-color: #f8d775;
        cursor: not-allowed;
      }

      .btn-block {
        display: block;
        width: 100%;
      }

      /* Status/progress styles */
      .progress-container {
        margin: 1rem 0;
        display: none;
      }

      .progress-bar {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-bar-inner {
        height: 100%;
        background-color: var(--primary-color);
        width: 0%;
        transition: width 0.3s ease;
      }

      .status-message {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: white !important;
        text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        font-weight: 500;
      }

      /* Results list styles */
      .business-list {
        margin-top: 1rem;
      }

      .business-item {
        background-color: #2a2a2a;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 1rem;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .business-header {
        background-color: var(--secondary-color);
        color: white;
        padding: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .business-body {
        padding: 1rem;
      }

      .business-type {
        font-size: 0.9rem;
        color: #2fcef0;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .business-contact {
        margin: 0.5rem 0;
        color: #ffffff;
      }

      .business-website a {
        color: var(--accent-color);
        text-decoration: none;
        font-weight: 500;
      }

      .business-website a:hover {
        text-decoration: underline;
      }

      .business-address {
        margin-top: 0.5rem;
        color: #ffffff !important;
      }

      .business-actions {
        display: flex;
        margin-top: 0.75rem;
        gap: 0.5rem;
      }

      .business-actions a {
        flex: 1;
        text-align: center;
        padding: 0.5rem;
        color: white;
        background-color: var(--secondary-color);
        border-radius: var(--border-radius);
        text-decoration: none;
        font-size: 0.9rem;
        transition: var(--transition);
      }

      .business-actions a:hover {
        opacity: 0.9;
      }

      .action-call {
        background-color: var(--success-color) !important;
      }

      .action-website {
        background-color: var(--accent-color) !important;
      }

      .action-map {
        background-color: var(--primary-color) !important;
        color: var(--dark-color) !important;
      }

      /* Files tab styles */
      .file-list {
        list-style: none;
      }

      .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        background-color: #2a2a2a;
      }

      /* FIX: File name overflow styles */
      .file-info {
        flex: 1;
        max-width: 70%; /* Limit width to ensure space for buttons */
        overflow: hidden; /* Hide overflow */
      }

      .file-name {
        font-weight: 500;
        color: var(--primary-color);
        overflow-wrap: break-word;
        word-break: break-all;
        white-space: normal;
        display: block;
      }

      .file-meta {
        font-size: 0.8rem;
        color: #cccccc;
        margin-top: 0.25rem;
      }

      .file-actions {
        display: flex;
        gap: 0.5rem;
      }

      .file-actions button {
        padding: 0.4rem 0.75rem;
        font-size: 0.9rem;
      }

      /* Spinner */
      .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(0, 0, 0, 0.3);
        border-radius: 50%;
        border-top-color: var(--dark-color);
        animation: spin 1s ease-in-out infinite;
        margin-right: 0.5rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Toast notification */
      .toast-container {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 1000;
      }

      .toast {
        background-color: #333;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: var(--border-radius);
        margin-top: 0.5rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        transform: translateY(100%);
        opacity: 0;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast.success {
        background-color: var(--success-color);
        color: white;
      }

      .toast.error {
        background-color: var(--danger-color);
        color: white;
      }

      .toast.info {
        background-color: #007bff;
        color: white;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      /* FIX: Updated modal content styles */
      .modal-content {
        background-color: white;
        border-radius: var(--border-radius);
        width: 95%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        padding: 1rem;
        background-color: var(--primary-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-weight: bold;
        margin: 0;
        color: #1a1a1a;
        overflow-wrap: break-word;
        word-break: break-all;
        white-space: normal;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }

      /* FIX: Updated modal body styles for scrolling */
      .modal-body {
        padding: 1rem;
        max-height: 70vh;
        overflow-y: auto;
      }

      .modal-footer {
        padding: 1rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
      }

      /* Container for the table that allows horizontal scrolling */
      .table-scroll-container {
        width: 100%;
        overflow-x: auto;
        margin-bottom: 1rem;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      }

      /* Table styling */
      .csv-preview-table {
        min-width: 100%;
        border-collapse: collapse;
        font-size: 14px; /* Base font size */
        table-layout: auto; /* Let columns size based on content */
        white-space: nowrap; /* Prevent text wrapping in cells */
      }

      .csv-preview-table th {
        background-color: var(--secondary-color);
        color: white;
        text-align: left;
        padding: 8px;
        font-weight: bold;
        border: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .csv-preview-table td {
        padding: 8px;
        border: 1px solid var(--border-color);
        max-width: 250px; /* Maximum width for any cell */
        overflow: hidden;
        text-overflow: ellipsis; /* Show ellipsis for overflowed content */
      }

      /* Special column handling */
      .csv-preview-table .col-website {
        min-width: 180px; /* Minimum width for website columns */
      }

      .csv-preview-table .col-address {
        min-width: 150px; /* Minimum width for address columns */
      }

      .csv-preview-table .col-name {
        min-width: 120px; /* Minimum width for name columns */
      }

      /* Zebra striping for rows */
      .csv-preview-table tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.05);
      }

      .csv-preview-table tr:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      /* Make links stand out */
      .csv-preview-table a {
        color: var(--accent-color);
        text-decoration: none;
      }

      .csv-preview-table a:hover {
        text-decoration: underline;
      }

      /* Results summary */
      .results-summary {
        background-color: #2a2a2a;
        color: #ffffff;
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
        text-align: center;
      }

      .results-summary h3 {
        margin-bottom: 0.5rem;
      }

      /* Progress container specific styles */
      .progress-container .status-message {
        color: white !important;
        font-weight: 500;
      }

      /* Responsive styles */
      @media (max-width: 768px) {
        header h1 {
          font-size: 1.5rem;
          margin-top: 30px;
        }

        .business-actions {
          flex-direction: column;
        }

        .file-item {
          flex-direction: column;
          gap: 20px;
          text-align: center;
        }

        .file-info {
          max-width: 100%; /* Full width in mobile view */
        }

        .file-name {
          font-size: 12px;
          word-wrap: break-word;
          overflow-wrap: break-word;
          word-break: break-all;
        }

        .csv-preview-table {
          font-size: 12px; /* Smaller font on mobile */
        }

        .csv-preview-table th,
        .csv-preview-table td {
          padding: 6px; /* Less padding on mobile */
        }
      }

      @media (max-width: 480px) {
        .container p {
          font-size: 12px;
        }

        header h1 {
          margin-top: 35px;
        }

        .modal-title {
          font-size: 14px;
        }
      }

      /* Dark mode styles */
      @media (prefers-color-scheme: dark) {
        :root {
          --light-color: #f0f0f0;
          --dark-color: #f8f9fa;
          --border-color: #555;
        }

        body {
          background-color: #222;
          color: var(--dark-color);
        }

        .card,
        .modal-content {
          background-color: #333;
        }

        input,
        select {
          background-color: #444;
          border-color: #555;
          color: white;
        }

        .file-meta {
          color: #adb5bd;
        }

        /* Improved nav visibility for dark mode */
        nav {
          background-color: #1a1a1a;
        }

        nav button {
          color: white;
          background-color: rgba(255, 255, 255, 0.15);
        }

        nav button:hover {
          background-color: rgba(255, 255, 255, 0.3);
        }

        nav button.active {
          background-color: var(--primary-color);
          color: black;
        }

        .spinner {
          border-color: rgba(255, 255, 255, 0.3);
          border-top-color: white;
        }

        /* Additional dark mode fixes */
        .modal-body {
          color: white;
        }

        /* FIX: Table styles for dark mode */
        .csv-preview-table th {
          background-color: #2a2a2a;
          border-color: #444;
        }

        .csv-preview-table td {
          border-color: #444;
        }
      }

      /* Light mode business info improvements */
      @media (prefers-color-scheme: light) {
        .business-item {
          background-color: white;
        }

        .business-contact,
        .business-address {
          color: #333 !important;
          font-weight: 500;
        }

        .business-type {
          color: #0a88a7;
          font-weight: 600;
        }

        /* Keep headers dark in light mode */
        .business-header {
          background-color: var(--secondary-color);
          color: white;
        }

        /* Ensure status messages are visible in light mode */
        .status-message {
          color: #333 !important;
        }

        .progress-container .status-message {
          color: #333 !important;
        }

        /* FIX: Table styles for light mode */
        .csv-preview-table th {
          background-color: var(--primary-color);
          color: var(--dark-color);
        }

        .csv-preview-table td {
          color: #333;
        }

        .csv-preview-table tr:nth-child(even) {
          background-color: rgba(0, 0, 0, 0.05);
        }

        .csv-preview-table tr:hover {
          background-color: rgba(0, 0, 0, 0.1);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1><i class="fas fa-search"></i> YellowPages Scraper</h1>
        <p>Find and collect business information on the go</p>
      </div>
    </header>
    <div style="position: absolute; top: 10px; right: 15px">
      <button
        id="logoutBtn"
        style="background: none; border: none; color: white; cursor: pointer"
      >
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
    <nav>
      <button id="searchTabBtn" class="active">
        <i class="fas fa-search"></i> Search
      </button>
      <button id="resultsTabBtn"><i class="fas fa-list"></i> Results</button>
      <button id="filesTabBtn"><i class="fas fa-file"></i> Files</button>
    </nav>

    <main>
      <div class="container">
        <!-- Search Tab -->
        <div id="searchTab" class="tab-content active">
          <div class="card">
            <div class="card-header">Search Parameters</div>
            <div class="card-body">
              <form id="searchForm">
                <div class="form-group">
                  <label for="query">What are you looking for?</label>
                  <input
                    type="text"
                    id="query"
                    name="query"
                    placeholder="e.g., pizza, plumbers, coffee shops"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="location">Where?</label>
                  <input
                    type="text"
                    id="location"
                    name="location"
                    placeholder="e.g., 90210, Los Angeles, CA"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="numResults">How many results? (5-300)</label>
                  <div class="range-container">
                    <input
                      type="range"
                      id="numResults"
                      name="numResults"
                      min="5"
                      max="300"
                      value="30"
                      step="5"
                    />
                    <span class="range-value" id="numResultsValue">30</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="saveFormat">Save format:</label>
                  <select id="saveFormat" name="saveFormat">
                    <option value="json">JSON</option>
                    <option value="csv">CSV</option>
                  </select>
                </div>

                <button type="submit" class="btn-block" id="searchBtn">
                  <i class="fas fa-search"></i> Start Search
                </button>
              </form>
            </div>
          </div>

          <!-- Progress Card (hidden initially) -->
          <div class="card progress-container" id="progressContainer">
            <div class="card-header">Search Progress</div>
            <div class="card-body">
              <div class="progress-bar">
                <div class="progress-bar-inner" id="progressBar"></div>
              </div>
              <div class="status-message" id="statusMessage">
                Starting search...
              </div>

              <div style="margin-top: 1rem; text-align: center">
                <button id="cancelSearchBtn" class="btn-danger">
                  <i class="fas fa-stop-circle"></i> Cancel Search
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Tab -->
        <div id="resultsTab" class="tab-content">
          <div class="results-summary" id="resultsSummary">
            <h3>No search results yet</h3>
            <p>Start a search to see results here</p>
          </div>

          <div class="card" id="resultsActions" style="display: none">
            <div class="card-body" style="display: flex; gap: 0.5rem">
              <button id="downloadResultsBtn" class="btn-block">
                <i class="fas fa-download"></i> Download Results
              </button>
            </div>
          </div>

          <div id="businessList" class="business-list">
            <!-- Business items will be appended here -->
          </div>
        </div>

        <!-- Files Tab -->
        <div id="filesTab" class="tab-content">
          <div class="card">
            <div class="card-header">Saved Files</div>
            <div class="card-body">
              <div class="form-group">
                <label for="fileFormatFilter">File format:</label>
                <select id="fileFormatFilter">
                  <option value="json">JSON</option>
                  <option value="csv">CSV</option>
                </select>
              </div>

              <ul class="file-list" id="fileList">
                <!-- File items will be appended here -->
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast notifications container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="filePreviewTitle">File Preview</h3>
          <button class="modal-close" id="closeFilePreviewBtn">&times;</button>
        </div>
        <div class="modal-body" id="filePreviewContent">
          <!-- File content will be rendered here -->
        </div>
        <div class="modal-footer">
          <button id="filePreviewDownloadBtn">
            <i class="fas fa-download"></i> Download
          </button>
          <button id="closePreviewBtn">Close</button>
        </div>
      </div>
    </div>

    <script>
      // DOM Elements
      const searchTabBtn = document.getElementById("searchTabBtn");
      const resultsTabBtn = document.getElementById("resultsTabBtn");
      const filesTabBtn = document.getElementById("filesTabBtn");
      const searchTab = document.getElementById("searchTab");
      const resultsTab = document.getElementById("resultsTab");
      const filesTab = document.getElementById("filesTab");

      const searchForm = document.getElementById("searchForm");
      const searchBtn = document.getElementById("searchBtn");
      const numResultsInput = document.getElementById("numResults");
      const numResultsValue = document.getElementById("numResultsValue");
      const cancelSearchBtn = document.getElementById("cancelSearchBtn");

      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const statusMessage = document.getElementById("statusMessage");

      const resultsSummary = document.getElementById("resultsSummary");
      const resultsActions = document.getElementById("resultsActions");
      const businessList = document.getElementById("businessList");
      const downloadResultsBtn = document.getElementById("downloadResultsBtn");

      const fileFormatFilter = document.getElementById("fileFormatFilter");
      const fileList = document.getElementById("fileList");

      const filePreviewModal = document.getElementById("filePreviewModal");
      const filePreviewTitle = document.getElementById("filePreviewTitle");
      const filePreviewContent = document.getElementById("filePreviewContent");
      const closeFilePreviewBtn = document.getElementById(
        "closeFilePreviewBtn"
      );
      const closePreviewBtn = document.getElementById("closePreviewBtn");
      const filePreviewDownloadBtn = document.getElementById(
        "filePreviewDownloadBtn"
      );

      const toastContainer = document.getElementById("toastContainer");

      // Current search state
      let currentSearchStatus = {
        isRunning: false,
        currentFile: null,
      };

      // Current results
      let currentResults = [];

      // Tab switching
      function showTab(tabId) {
        // Hide all tabs
        searchTab.classList.remove("active");
        resultsTab.classList.remove("active");
        filesTab.classList.remove("active");

        // Deactivate all buttons
        searchTabBtn.classList.remove("active");
        resultsTabBtn.classList.remove("active");
        filesTabBtn.classList.remove("active");

        // Show selected tab
        document.getElementById(tabId).classList.add("active");

        // Activate corresponding button
        document.getElementById(tabId + "Btn").classList.add("active");

        // Load content for files tab if selected
        if (tabId === "filesTab") {
          loadFiles();
        }
      }

      // Tab button event listeners
      searchTabBtn.addEventListener("click", () => showTab("searchTab"));
      resultsTabBtn.addEventListener("click", () => showTab("resultsTab"));
      filesTabBtn.addEventListener("click", () => showTab("filesTab"));

      // Range slider value display
      numResultsInput.addEventListener("input", () => {
        numResultsValue.textContent = numResultsInput.value;
      });

      // Toast notification function
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        toastContainer.appendChild(toast);

        // Trigger reflow to enable animation
        toast.offsetHeight;

        // Show toast
        toast.classList.add("show");

        // Hide and remove toast after 3 seconds
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            toastContainer.removeChild(toast);
          }, 300);
        }, 3000);
      }

      // Search form submission
      searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // If a search is already running, do nothing
        if (currentSearchStatus.isRunning) {
          showToast("A search is already in progress", "error");
          return;
        }

        // Get form data
        const formData = new FormData(searchForm);
        const searchData = {
          query: formData.get("query"),
          location: formData.get("location"),
          numResults: formData.get("numResults"),
          saveFormat: formData.get("saveFormat"),
        };

        // Disable search button
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<div class="spinner"></div> Starting...';

        // Show progress container
        progressContainer.style.display = "block";

        try {
          // Start the search
          const response = await fetch("/api/search", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(searchData),
          });

          const data = await response.json();

          if (data.success) {
            // Search started successfully
            currentSearchStatus.isRunning = true;

            // Start polling for status updates
            startStatusPolling();

            showToast("Search started successfully");
          } else {
            // Search failed to start
            searchBtn.disabled = false;
            searchBtn.innerHTML = '<i class="fas fa-search"></i> Start Search';
            progressContainer.style.display = "none";

            showToast(
              `Error: ${data.error || "Failed to start search"}`,
              "error"
            );
          }
        } catch (error) {
          // Network or other error
          searchBtn.disabled = false;
          searchBtn.innerHTML = '<i class="fas fa-search"></i> Start Search';
          progressContainer.style.display = "none";

          showToast(`Error: ${error.message || "Network error"}`, "error");
        }
      });

      // Poll for search status updates
      function startStatusPolling() {
        const pollInterval = setInterval(async () => {
          try {
            const response = await fetch("/api/status");
            const data = await response.json();

            if (data.success) {
              updateSearchStatus(data.status);

              // If search is no longer running, stop polling
              if (!data.status.isRunning) {
                clearInterval(pollInterval);
                searchCompleted(data.status);
              }
            } else {
              showToast(
                `Error: ${data.error || "Failed to get status"}`,
                "error"
              );
            }
          } catch (error) {
            showToast(`Error: ${error.message || "Network error"}`, "error");
          }
        }, 1000); // Poll every second
      }

      // Update search status display
      function updateSearchStatus(status) {
        // Update progress bar
        progressBar.style.width = `${status.progress}%`;

        // Update status message
        statusMessage.textContent = status.statusMessage;

        // Store current file if available
        if (status.currentFile) {
          currentSearchStatus.currentFile = status.currentFile;
        }
      }

      // Handle search completion
      function searchCompleted(status) {
        // Re-enable search button
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<i class="fas fa-search"></i> Start Search';

        // Update search status
        currentSearchStatus.isRunning = false;

        if (status.error) {
          // Search completed with error
          showToast(`Search error: ${status.error}`, "error");
          progressContainer.style.display = "none";
        } else {
          // Search completed successfully
          showToast("Search completed successfully", "success");
          progressBar.style.width = "100%";

          // Delay hiding progress container to show 100% completion
          setTimeout(() => {
            progressContainer.style.display = "none";
          }, 1500);

          // If we have a current file, load the results
          if (currentSearchStatus.currentFile) {
            loadResults(currentSearchStatus.currentFile);
          } else {
            // Otherwise, load the file list to find the latest file
            loadFiles();
          }
        }
      }

      // Cancel search button
      cancelSearchBtn.addEventListener("click", async () => {
        if (!currentSearchStatus.isRunning) return;

        try {
          const response = await fetch("/api/cancel", {
            method: "POST",
          });

          const data = await response.json();

          if (data.success) {
            showToast("Search cancelled");
          } else {
            showToast(`Failed to cancel search: ${data.message}`, "error");
          }
        } catch (error) {
          showToast(`Error: ${error.message || "Network error"}`, "error");
        }
      });

      // Load list of files
      async function loadFiles() {
        const format = fileFormatFilter.value;

        try {
          // Clear file list
          fileList.innerHTML = '<li class="file-item">Loading files...</li>';

          const response = await fetch(`/api/files/${format}`);
          const data = await response.json();

          if (data.success) {
            if (data.files.length === 0) {
              fileList.innerHTML = '<li class="file-item">No files found</li>';
              return;
            }

            // Clear file list
            fileList.innerHTML = "";

            // Add file items
            data.files.forEach((file) => {
              const fileItem = document.createElement("li");
              fileItem.className = "file-item";

              const fileSize = formatFileSize(file.size);
              const fileDate = new Date(file.modified).toLocaleString();

              fileItem.innerHTML = `
              <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-meta">${fileSize} - ${fileDate}</div>
              </div>
              <div class="file-actions">
                <button class="file-preview-btn" data-filename="${file.name}" data-format="${format}">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="file-download-btn" data-filename="${file.name}" data-format="${format}">
                  <i class="fas fa-download"></i>
                </button>
                <button class="file-delete-btn" data-filename="${file.name}" data-format="${format}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            `;

              fileList.appendChild(fileItem);
            });

            // Add event listeners to file action buttons
            document.querySelectorAll(".file-preview-btn").forEach((btn) => {
              btn.addEventListener("click", () => {
                const filename = btn.getAttribute("data-filename");
                const format = btn.getAttribute("data-format");
                previewFile(filename, format);
              });
            });

            document.querySelectorAll(".file-download-btn").forEach((btn) => {
              btn.addEventListener("click", () => {
                const filename = btn.getAttribute("data-filename");
                const format = btn.getAttribute("data-format");
                downloadFile(filename, format);
              });
            });

            document.querySelectorAll(".file-delete-btn").forEach((btn) => {
              btn.addEventListener("click", () => {
                const filename = btn.getAttribute("data-filename");
                const format = btn.getAttribute("data-format");
                deleteFile(filename, format);
              });
            });
          } else {
            fileList.innerHTML = `<li class="file-item">Error: ${data.error}</li>`;
          }
        } catch (error) {
          fileList.innerHTML = `<li class="file-item">Error: ${
            error.message || "Network error"
          }</li>`;
        }
      }

      // Format file size
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        else return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }

      // File format filter change
      fileFormatFilter.addEventListener("change", loadFiles);

      // Preview file
      async function previewFile(filename, format) {
        try {
          // Set modal title
          filePreviewTitle.textContent = filename;

          // Show loading in modal
          filePreviewContent.innerHTML =
            '<div style="text-align:center;"><div class="spinner"></div> Loading preview...</div>';

          // Show modal
          filePreviewModal.style.display = "flex";

          // Set download button link
          filePreviewDownloadBtn.setAttribute("data-filename", filename);
          filePreviewDownloadBtn.setAttribute("data-format", format);

          // Fetch file content
          const response = await fetch(`/api/results/${format}/${filename}`);

          if (!response.ok) {
            filePreviewContent.innerHTML = `<div style="color:red;">Error: ${response.status} ${response.statusText}</div>`;
            return;
          }

          if (format === "json") {
            const data = await response.json();

            if (data.success) {
              // Create preview content for JSON
              const results = data.results;

              if (results.length === 0) {
                filePreviewContent.innerHTML =
                  "<div>No results in this file</div>";
                return;
              }

              // Show basic stats
              let previewHTML = `
              <div class="results-summary">
                <h3>${results.length} businesses found</h3>
              </div>
            `;

              // Show first 5 businesses
              const previewLimit = Math.min(results.length, 5);
              previewHTML +=
                '<div style="font-weight:bold; margin-bottom:0.5rem;">Preview (first 5 entries):</div>';

              for (let i = 0; i < previewLimit; i++) {
                const business = results[i];
                previewHTML += `
                <div style="margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border-color);">
                  <div style="font-weight:bold;">${business.businessName}</div>
                  <div>${business.businessType || "N/A"}</div>
                  <div>${business.phone || "No phone"} | ${
                  business.website ? "Has website" : "No website"
                }</div>
                  <div>${business.streetAddress}, ${business.city}, ${
                  business.state
                } ${business.zipCode}</div>
                </div>
              `;
              }

              if (results.length > previewLimit) {
                previewHTML += `<div>... and ${
                  results.length - previewLimit
                } more entries</div>`;
              }

              filePreviewContent.innerHTML = previewHTML;
            } else {
              filePreviewContent.innerHTML = `<div style="color:red;">Error: ${data.error}</div>`;
            }
          } else if (format === "csv") {
            const text = await response.text();

            // Parse CSV properly, handling commas within quoted fields
            function parseCSVLine(line) {
              const result = [];
              let cell = "";
              let inQuotes = false;

              for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                  // Handle quotes
                  if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                    // Escaped quote inside a quoted field
                    cell += '"';
                    i++; // Skip the next quote
                  } else {
                    // Toggle quote state
                    inQuotes = !inQuotes;
                  }
                } else if (char === "," && !inQuotes) {
                  // End of cell
                  result.push(cell);
                  cell = "";
                } else {
                  // Add character to current cell
                  cell += char;
                }
              }

              // Add the last cell
              result.push(cell);
              return result;
            }

            // Split into lines and clean up
            const lines = text.split("\n").filter((line) => line.trim());

            // Parse headers and data
            const headers = parseCSVLine(lines[0]);

            if (lines.length <= 1) {
              filePreviewContent.innerHTML =
                "<div>No results in this file</div>";
              return;
            }

            // Show basic stats
            let previewHTML = `
              <div class="results-summary">
                <h3>${lines.length - 1} businesses found</h3>
              </div>
            `;

            // Show preview header
            previewHTML +=
              '<div style="font-weight:bold; margin-bottom:0.5rem;">Preview (first 5 entries):</div>';

            // Determine preview limit
            const previewLimit = Math.min(lines.length, 6); // Include header + 5 rows

            // Create table with our new CSS class and horizontal scrolling container
            previewHTML += '<div class="table-scroll-container">';
            previewHTML += '<table class="csv-preview-table">';

            // Add header row
            previewHTML += "<tr>";
            headers.forEach((header, index) => {
              // Clean up header text
              const cleanHeader = header.replace(/^"(.*)"$/, "$1").trim();

              // Determine column class based on header name
              let colClass = "";
              if (/website|url|web/i.test(cleanHeader)) {
                colClass = "col-website";
              } else if (/address|street|location/i.test(cleanHeader)) {
                colClass = "col-address";
              } else if (/name|business|company/i.test(cleanHeader)) {
                colClass = "col-name";
              }

              previewHTML += `<th class="${colClass}">${cleanHeader}</th>`;
            });
            previewHTML += "</tr>";

            // Add data rows
            for (let i = 1; i < previewLimit; i++) {
              if (i >= lines.length) break;

              const cells = parseCSVLine(lines[i]);
              previewHTML += "<tr>";

              cells.forEach((cell, index) => {
                // Clean up cell text
                const cleanCell = cell.replace(/^"(.*)"$/, "$1").trim();

                // Determine column class based on header name if available
                let colClass = "";
                if (index < headers.length) {
                  const headerText = headers[index]
                    .replace(/^"(.*)"$/, "$1")
                    .trim();
                  if (/website|url|web/i.test(headerText)) {
                    colClass = "col-website";
                  } else if (/address|street|location/i.test(headerText)) {
                    colClass = "col-address";
                  } else if (/name|business|company/i.test(headerText)) {
                    colClass = "col-name";
                  }
                }

                // Handle different cell types differently
                if (index < headers.length) {
                  const headerText = headers[index]
                    .replace(/^"(.*)"$/, "$1")
                    .trim();

                  if (
                    /website|url|web/i.test(headerText) &&
                    cleanCell.startsWith("http")
                  ) {
                    // Make websites clickable
                    previewHTML += `<td class="${colClass}"><a href="${cleanCell}" target="_blank">${cleanCell}</a></td>`;
                  } else if (/phone/i.test(headerText)) {
                    // Format phone numbers consistently
                    previewHTML += `<td class="${colClass}">${cleanCell}</td>`;
                  } else {
                    // Regular cell
                    previewHTML += `<td class="${colClass}">${cleanCell}</td>`;
                  }
                } else {
                  // Extra cell
                  previewHTML += `<td>${cleanCell}</td>`;
                }
              });

              // Add empty cells if row has fewer cells than headers
              if (cells.length < headers.length) {
                for (let j = cells.length; j < headers.length; j++) {
                  previewHTML += `<td></td>`;
                }
              }

              previewHTML += "</tr>";
            }

            previewHTML += "</table>";
            previewHTML += "</div>"; // Close table-scroll-container

            if (lines.length > previewLimit) {
              previewHTML += `<div>... and ${
                lines.length - previewLimit
              } more entries</div>`;
            }

            filePreviewContent.innerHTML = previewHTML;
          }
        } catch (error) {
          filePreviewContent.innerHTML = `<div style="color:red;">Error: ${
            error.message || "Failed to load preview"
          }</div>`;
        }
      }

      // Download file
      function downloadFile(filename, format) {
        window.location.href = `/download/${format}/${filename}`;
      }

      // Delete file
      async function deleteFile(filename, format) {
        if (!confirm(`Are you sure you want to delete ${filename}?`)) {
          return;
        }

        try {
          const response = await fetch(`/api/files/${format}/${filename}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (data.success) {
            showToast(`File ${filename} deleted successfully`, "success");
            loadFiles();
          } else {
            showToast(
              `Error: ${data.error || "Failed to delete file"}`,
              "error"
            );
          }
        } catch (error) {
          showToast(`Error: ${error.message || "Network error"}`, "error");
        }
      }

      // Close file preview modal
      closeFilePreviewBtn.addEventListener("click", () => {
        filePreviewModal.style.display = "none";
      });

      closePreviewBtn.addEventListener("click", () => {
        filePreviewModal.style.display = "none";
      });

      // Download from preview modal
      filePreviewDownloadBtn.addEventListener("click", () => {
        const filename = filePreviewDownloadBtn.getAttribute("data-filename");
        const format = filePreviewDownloadBtn.getAttribute("data-format");
        downloadFile(filename, format);
      });

      // Load results
      async function loadResults(file) {
        if (!file) return;

        // Show results tab
        showTab("resultsTab");

        // Parse filename to get format
        const parts = file.name.split(".");
        const format = parts[parts.length - 1];

        try {
          resultsSummary.innerHTML =
            '<div class="spinner"></div> Loading results...';
          businessList.innerHTML = "";

          const response = await fetch(`/api/results/${format}/${file.name}`);

          if (!response.ok) {
            resultsSummary.innerHTML = `<h3>Error</h3><p>Failed to load results: ${response.status} ${response.statusText}</p>`;
            return;
          }

          if (format === "json") {
            const data = await response.json();

            if (data.success) {
              currentResults = data.results;

              // Update summary
              resultsSummary.innerHTML = `
              <h3>${data.totalResults} businesses found</h3>
              <p>Search for "${extractSearchQuery(
                file.name
              )}" in "${extractSearchLocation(file.name)}"</p>
            `;

              // Show download button
              resultsActions.style.display = "block";
              downloadResultsBtn.setAttribute("data-filename", file.name);
              downloadResultsBtn.setAttribute("data-format", format);

              // Render businesses
              renderBusinessList(data.results);
            } else {
              resultsSummary.innerHTML = `<h3>Error</h3><p>${data.error}</p>`;
            }
          } else if (format === "csv") {
            // For CSV, we'll display a simplified view
            const text = await response.text();
            const lines = text.split("\n");
            const headers = lines[0].split(",");

            // Convert CSV to array of objects
            const results = [];
            for (let i = 1; i < lines.length; i++) {
              if (!lines[i].trim()) continue;

              const values = lines[i].split(",");
              const business = {};

              headers.forEach((header, index) => {
                const value = values[index] || "";
                // Remove quotes if present
                business[header.trim().replace(/^"(.+)"$/, "$1")] =
                  value.replace(/^"(.+)"$/, "$1");
              });

              results.push(business);
            }

            currentResults = results;

            // Update summary
            resultsSummary.innerHTML = `
            <h3>${results.length} businesses found</h3>
            <p>Search for "${extractSearchQuery(
              file.name
            )}" in "${extractSearchLocation(file.name)}"</p>
          `;

            // Show download button
            resultsActions.style.display = "block";
            downloadResultsBtn.setAttribute("data-filename", file.name);
            downloadResultsBtn.setAttribute("data-format", format);

            // Render businesses
            renderBusinessList(results);
          }
        } catch (error) {
          resultsSummary.innerHTML = `<h3>Error</h3><p>${
            error.message || "Failed to load results"
          }</p>`;
        }
      }

      // Extract search query from filename
      function extractSearchQuery(filename) {
        // Filename format: query_location_date.ext
        const parts = filename.split("_");
        if (parts.length < 2) return "Unknown";

        return parts[0].replace(/_/g, " ");
      }

      // Extract search location from filename
      function extractSearchLocation(filename) {
        // Filename format: query_location_date.ext
        const parts = filename.split("_");
        if (parts.length < 3) return "Unknown";

        // Location may have multiple parts, so join everything between query and date
        const datePartIndex = parts.length - 3; // date has 3 parts: mm_dd_yyyy

        return parts.slice(1, datePartIndex).join(" ");
      }

      // Render business list
      function renderBusinessList(businesses) {
        businessList.innerHTML = "";

        businesses.forEach((business) => {
          const item = document.createElement("div");
          item.className = "business-item";

          // Handle different property names between JSON and CSV
          const name =
            business.businessName || business["Business Name"] || "Unknown";
          const type = business.businessType || business["Business Type"] || "";
          const phone = business.phone || business["Phone"] || "";
          const website = business.website || business["Website"] || "";
          const street =
            business.streetAddress || business["Street Address"] || "";
          const city = business.city || business["City"] || "";
          const state = business.state || business["State"] || "";
          const zip = business.zipCode || business["ZIP Code"] || "";

          item.innerHTML = `
          <div class="business-header">
            <h3>${name}</h3>
          </div>
          <div class="business-body">
            <div class="business-type">${type}</div>
            <div class="business-contact">${phone}</div>
            <div class="business-website">${
              website
                ? `<a href="${website}" target="_blank">${website}</a>`
                : "No website"
            }</div>
            <div class="business-address">${street}, ${city}, ${state} ${zip}</div>
            
            <div class="business-actions">
              ${
                website
                  ? `<a href="${website}" target="_blank" class="action-website"><i class="fas fa-globe"></i> Website</a>`
                  : ""
              }
              <a href="https://maps.google.com/?q=${encodeURIComponent(
                `${street}, ${city}, ${state} ${zip}`
              )}" target="_blank" class="action-map">
                <i class="fas fa-map-marker-alt"></i> Map
              </a>
            </div>
          </div>
        `;

          businessList.appendChild(item);
        });
      }

      // Download results button
      downloadResultsBtn.addEventListener("click", () => {
        const filename = downloadResultsBtn.getAttribute("data-filename");
        const format = downloadResultsBtn.getAttribute("data-format");
        downloadFile(filename, format);
      });

      // Load files on startup
      loadFiles();
    </script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
      // Firebase configuration - Direct from your DevLeads project
      const firebaseConfig = {
        apiKey: "AIzaSyCrfRmWqJ3SZqwuSdffAXJIf3ZeyCTPljc",
        authDomain: "yp-web-scraper.firebaseapp.com",
        projectId: "yp-web-scraper",
        storageBucket: "yp-web-scraper.firebasestorage.app",
        messagingSenderId: "221521626432",
        appId: "1:221521626432:web:3eb88a13abcf620931e6a5",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      // Check authentication
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          // No user signed in, redirect to login
          window.location.href = "/login";
        }
      });

      // Handle logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        // Show loading indicator
        const logoutBtn = document.getElementById("logoutBtn");
        const originalContent = logoutBtn.innerHTML;
        logoutBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Logging out...';

        firebase
          .auth()
          .signOut()
          .then(() => {
            window.location.href = "/login";
          })
          .catch((error) => {
            console.error("Logout error:", error);
            // Restore button on error
            logoutBtn.innerHTML = originalContent;
          });
      });
    </script>
  </body>
</html>
